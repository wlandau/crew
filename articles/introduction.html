<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="crew">
<title>Introduction to crew • crew</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to crew">
<meta property="og:description" content="crew">
<meta property="og:image" content="https://wlandau.github.io/crew/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">crew</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.2.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>How to use `crew`</h6>
    <a class="dropdown-item" href="../articles/introduction.html">Introduction to crew</a>
    <a class="dropdown-item" href="../articles/groups.html">Controller groups</a>
    <a class="dropdown-item" href="../articles/shiny.html">Asynchronous Shiny apps</a>
    <a class="dropdown-item" href="../articles/promises.html">Integration with promises</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Technical details</h6>
    <a class="dropdown-item" href="../articles/plugins.html">Launcher plugins</a>
    <a class="dropdown-item" href="../articles/risks.html">Known risks of crew</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/wlandau/crew/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Introduction to crew</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/wlandau/crew/blob/HEAD/vignettes/introduction.Rmd" class="external-link"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<p><code>crew</code> is a distributed computing framework with a
centralized interface and auto-scaling. A <code>crew</code> controller
is an object in R which accepts tasks, returns results, and launches
workers. Workers can be local processes, jobs on traditional clusters
such as SLURM, or jobs on cloud services such as AWS Batch, depending on
the <a href="https://wlandau.github.io/crew/articles/plugins.html">launcher
plugin</a> of the controller.</p>
<div class="section level2">
<h2 id="tasks-vs-workers">Tasks vs workers<a class="anchor" aria-label="anchor" href="#tasks-vs-workers"></a>
</h2>
<p>A <em>task</em> is a piece of R code, such as an expression or a
function call. A <em>worker</em> is a <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/interactive.html" class="external-link">non-interactive</a>
R process that runs one or more tasks. When tasks run on workers, the
local R session is free and responsive, and work gets done faster. For
example, <a href="https://wlandau.github.io/crew/articles/shiny.html">this
vignette</a> shows how <code>crew</code> and <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> work
together to speed up <a href="https://rstudio.github.io/shiny/" class="external-link">Shiny</a> apps.</p>
</div>
<div class="section level2">
<h2 id="how-to-use-crew">How to use <code>crew</code><a class="anchor" aria-label="anchor" href="#how-to-use-crew"></a>
</h2>
<p>First, create a controller object to manage tasks and workers.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wlandau.github.io/crew/">crew</a></span><span class="op">)</span></span>
<span><span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/crew_controller_local.html">crew_controller_local</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"example"</span>,</span>
<span>  workers <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  seconds_idle <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, start the controller to create the <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a>
client. Later, when you are done with the controller, call
<code>controller$terminate()</code> to clean up the workers and
dispatcher.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Use <code>push()</code> to submit a new task and <code>pop()</code>
to return a completed task.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"get pid"</span>, command <span class="op">=</span> <span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_pid.html" class="external-link">ps_pid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>As a side effect, methods <code>push()</code>, <code>pop()</code>,
and <code><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale()</a></code> also launch workers to run the tasks. If your
controller uses transient workers and has a backlog of tasks, you may
need to loop over <code>pop()</code> or <code><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale()</a></code> multiple
times to make sure enough workers are always available.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span><span class="op">)</span> <span class="co"># No workers started yet and the task is not done.</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span><span class="op">)</span> <span class="co"># Worker started, task complete.</span></span>
<span><span class="va">task</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 12</span></span>
<span><span class="co">#&gt;   name    command result seconds  seed algorithm error trace warnings</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;list&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 get pid NA      &lt;int&gt;        0    NA NA        NA    NA    NA</span></span>
<span><span class="co">#&gt; # ℹ 3 more variables: launcher &lt;chr&gt;, worker &lt;int&gt;, instance &lt;chr&gt;</span></span></code></pre></div>
<p>Alternatively, <code>wait()</code> is a loop that repeatedly checks
tasks and launches workers until all tasks complete.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<p>The return value of the task is in the <code>result</code>
column.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># return value of the task</span></span>
<span><span class="co">#&gt; [1] 69631</span></span></code></pre></div>
<p>Here is the full list of output in the <code>task</code> object
returned by <code>pop()</code>.</p>
<ul>
<li>
<code>name</code>: the task name if given.</li>
<li>
<code>command</code>: a character string with the R command if
<code>save_command</code> was set to <code>TRUE</code> in
<code>push()</code>.</li>
<li>
<code>result</code>: a list containing the return value of the R
command.</li>
<li>
<code>seconds</code>: number of seconds that the task ran.</li>
<li>
<code>seed</code>: the single integer originally supplied to
<code>push()</code>, <code>NA</code> if <code>seed</code> was supplied
as <code>NULL</code>.</li>
<li>
<code>algorithm</code>: name of the pseudo-random number generator
algorithm originally supplied to <code>push()</code>, <code>NA</code> if
<code>algorithm</code> was supplied as <code>NULL</code>.</li>
<li>
<code>error</code>: the first 2048 characters of the error message
if the task threw an error, <code>NA</code> otherwise.</li>
<li>
<code>trace</code>: the first 2048 characters of the text of the
traceback if the task threw an error, <code>NA</code> otherwise.</li>
<li>
<code>warnings</code>: the first 2048 characters. of the text of
warning messages that the task may have generated, <code>NA</code>
otherwise.</li>
<li>
<code>launcher</code>: name of the <code>crew</code> launcher where
the task ran.</li>
</ul>
<p>If <code>seed</code> and <code>algorithm</code> are both non-missing
in the output, then you can recover the pseudo-random number generator
state of the task using
<code>set.seed(seed = seed, kind = algorithm)</code>. However, it is
recommended to supply <code>NULL</code> to these arguments in
<code>push()</code>, in which case you will observe <code>NA</code> in
the outputs. With <code>seed</code> and <code>algorithm</code> both
<code>NULL</code>, the random number generator defaults to the
recommended widely spaced worker-specific L’Ecuyer streams supported by
<code><a href="https://shikokuchuo.net/mirai/reference/nextstream.html" class="external-link">mirai::nextstream()</a></code>. See
<code><a href="https://cran.rstudio.com/web/packages/parallel/vignettes/parallel.pdf" class="external-link">vignette("parallel", package = "parallel")</a></code> for details.</p>
</div>
<div class="section level2">
<h2 id="synchronous-functional-programming">Synchronous functional programming<a class="anchor" aria-label="anchor" href="#synchronous-functional-programming"></a>
</h2>
<p>The <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-map"><code>map()</code></a>
method of the controller supports functional programming similar to <a href="https://purrr.tidyverse.org/reference/map.html" class="external-link"><code>purrr::map()</code></a>
and <a href="https://mschubert.github.io/clustermq/reference/Q.html" class="external-link"><code>clustermq::Q()</code></a>.
The arguments of <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-map"><code>map()</code></a>
are mostly the same those of <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-push"><code>push()</code></a>,
but there is a new <code>iterate</code> argument to define the inputs of
individual tasks. <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-map"><code>map()</code></a>
submits a whole collection of tasks, auto-scales the workers, waits for
all the tasks to finish, and returns the results in a
<code>tibble</code>.</p>
<p>Below, <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-map"><code>map()</code></a>
submits one task to compute <code>1 + 2 + 5 + 6</code> and another task
to compute <code>3 + 4 + 5 + 6</code>. The lists and vectors inside
<code>iterate</code> vary from task to task, while the elements of
<code>data</code> and <code>globals</code> stay constant across
tasks.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span></span>
<span>  command <span class="op">=</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">c</span> <span class="op">+</span> <span class="va">d</span>,</span>
<span>  iterate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>c <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  globals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>d <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 12</span></span>
<span><span class="co">#&gt;   name  command result    seconds  seed algorithm error trace warnings</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;list&gt;      &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 1     NA      &lt;dbl [1]&gt;       0    NA NA        NA    NA    NA</span></span>
<span><span class="co">#&gt; 2 2     NA      &lt;dbl [1]&gt;       0    NA NA        NA    NA    NA</span></span>
<span><span class="co">#&gt; # ℹ 3 more variables: launcher &lt;chr&gt;, worker &lt;int&gt;, instance &lt;chr&gt;</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 14 18</span></span></code></pre></div>
<p>If at least one task in <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-map"><code>map()</code></a>
throws an error, the default behavior is to error out in the main
session and not return the results, If that happens, the results are
available in the <code>controller$error</code>. To return the results
instead of setting <code>controller$error</code>, regardless of error
status, set <code>error = "warn"</code> or <code>"silent"</code> in <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-map"><code>map()</code></a>.
To conserve memory, consider setting
<code>controller$error &lt;- NULL</code> when you are done
troubleshooting.</p>
</div>
<div class="section level2">
<h2 id="asynchronous-functional-programming">Asynchronous functional programming<a class="anchor" aria-label="anchor" href="#asynchronous-functional-programming"></a>
</h2>
<p>The <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-walk"><code>walk()</code></a>
method is just like <code>map()</code>, but it does not wait for any
tasks to complete. Instead, it returns control to the local R session
immediately and lets you do other things while the tasks run in the
background.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">walk</span><span class="op">(</span></span>
<span>  command <span class="op">=</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">c</span> <span class="op">+</span> <span class="va">d</span>,</span>
<span>  iterate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>c <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  globals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>d <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-collect"><code>collect()</code></a>
pops all completed tasks. Put together, <code>walk()</code>,
<code>wait(mode = "all")</code>, and <code>collect()</code> have the
same overall effect as <code>map()</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 12</span></span>
<span><span class="co">#&gt;   name  command result    seconds  seed algorithm error trace warnings</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;list&gt;      &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 1     NA      &lt;dbl [1]&gt;       0    NA NA        NA    NA    NA</span></span>
<span><span class="co">#&gt; 2 2     NA      &lt;dbl [1]&gt;       0    NA NA        NA    NA    NA</span></span>
<span><span class="co">#&gt; # ℹ 3 more variables: launcher &lt;chr&gt;, worker &lt;int&gt;, instance &lt;chr&gt;</span></span></code></pre></div>
<p>However, there are subtle differences between the synchronous and
asynchronous functional programming methods:</p>
<ol style="list-style-type: decimal">
<li>
<code>map()</code> requires an empty controller to start with (no
prior tasks). But with <code>walk()</code>, the controller can have any
number of running or unpopped tasks beforehand.</li>
<li>
<code>wait()</code> does not show a progress bar because it would be
misleading if there are a lot of prior tasks. Because <code>map()</code>
requires the controller to be empty initially (i.e. (1)), it shows a
progress bar while correctly representing the amount of work left to
do.</li>
</ol>
</div>
<div class="section level2">
<h2 id="summaries">Summaries<a class="anchor" aria-label="anchor" href="#summaries"></a>
</h2>
<p>The controller summary shows how many tasks each worker ran, how many
total seconds it spent running tasks, and how many tasks threw warnings
and errors.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 6</span></span>
<span><span class="co">#&gt;   controller worker tasks seconds errors warnings</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;  &lt;int&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 example         1     2   0.001      0        0</span></span>
<span><span class="co">#&gt; 2 example         2     1   0          0        0</span></span></code></pre></div>
<p>The launcher summary counts the number of times each worker was
launched, and it shows the total number of assigned and completed tasks
from all past terminated instances of each worker. In addition, it shows
whether the current worker instance was actively connected (“online”) or
had connected at some point during its life cycle (“discovered”) as of
the last call to <code>controller$launcher$tally()</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="va">launcher</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 6</span></span>
<span><span class="co">#&gt;   worker launches online discovered assigned complete</span></span>
<span><span class="co">#&gt;    &lt;int&gt;    &lt;int&gt; &lt;lgl&gt;  &lt;lgl&gt;         &lt;int&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1      1        2 TRUE   TRUE              0        0</span></span>
<span><span class="co">#&gt; 2      2        1 TRUE   TRUE              0        0</span></span></code></pre></div>
<p>Finally, the client summary shows up-to-date worker status from
<code><a href="https://shikokuchuo.net/mirai/reference/daemons.html" class="external-link">mirai::daemons()</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="va">client</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 6</span></span>
<span><span class="co">#&gt;   worker online instances assigned complete socket</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;lgl&gt;      &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1      1 FALSE          1        2        2 ws://10.0.0.32:58685/1/15e07250…</span></span>
<span><span class="co">#&gt; 2      2 FALSE          1        1        1 ws://10.0.0.32:58685/2/cb45b3d4…</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="termination">Termination<a class="anchor" aria-label="anchor" href="#termination"></a>
</h2>
<p>Call <code>terminate()</code> on the controller after you finish
using it. <code>terminate()</code> tries to close the the <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a>
dispatcher and any workers that may still be running. It is important to
free up these resources.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">terminate</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The <code>mirai</code> dispatcher process should exit on its own, but
if not, you can manually terminate the process ID at
<code>controller$client$dispatcher</code> or call
<code><a href="../reference/crew_clean.html">crew_clean()</a></code> to terminate any dispatchers from current or
previous R sessions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/crew_clean.html">crew_clean</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; nothing to clean up</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="monitoring-local-processes">Monitoring local processes<a class="anchor" aria-label="anchor" href="#monitoring-local-processes"></a>
</h2>
<p>A <code>crew</code> controller creates different types of local
processes. These include:</p>
<ul>
<li>Dispatchers: every controller has a special local process called a
“dispatcher”. <a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a> needs
this process to orchestrate tasks.</li>
<li>Workers: the R processes that <code>crew</code> launches to run
tasks. These may be local processes as in the case of
<code><a href="../reference/crew_controller_local.html">crew_controller_local()</a></code>, or they may be processes on
different computers if you are using a third-party <a href="https://wlandau.github.io/crew/articles/plugins.html">launcher
plugin</a> like <code>crew.cluster</code> or
<code>crew.aws.batch</code>. launches processes.</li>
<li>Daemons: R processes created by <code>mirai</code> outside of
<code>crew</code> to run tasks. Such processes may spawn automatically
if you set the <code>processes</code> argument of
e.g. <code>crew.aws.batch::crew_controller_aws_batch()</code> to a
positive integer.</li>
</ul>
<p>Usually these processes terminate themselves when the parent R
session exits or the controller terminates, but under rare circumstances
they may continue running. The “local monitor” in <code>crew</code>
makes it easy to list and terminate any of these processes which may be
running on your local computer. Example:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">monitor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/crew_monitor_local.html">crew_monitor_local</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">dispatchers</span><span class="op">(</span><span class="op">)</span> <span class="co"># List PIDs of all local {mirai} dispatcher processes.</span></span>
<span><span class="co">#&gt; [1] 31215</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">daemons</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">workers</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 57001 57002</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">terminate</span><span class="op">(</span>pid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">57001</span>, <span class="fl">57002</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">workers</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span></code></pre></div>
<p><code><a href="../reference/crew_monitor_local.html">crew_monitor_local()</a></code> only manages processes running on
your local computer. To manage <code>crew</code> workers running on
different computers, such as SLURM or AWS Batch, please familiarize
yourself with the given computing platform, and consider using the
monitor objects in the relevant third-party plugin packages such as <a href="https://wlandau.github.io/crew.cluster/"><code>crew.cluster</code></a>
or <a href="https://wlandau.github.io/crew.aws.batch/"><code>crew.aws.batch</code></a>.
Example: <a href="https://wlandau.github.io/crew.aws.batch/index.html#job-management" class="uri">https://wlandau.github.io/crew.aws.batch/index.html#job-management</a>.</p>
</div>
<div class="section level2">
<h2 id="tuning-and-auto-scaling">Tuning and auto-scaling<a class="anchor" aria-label="anchor" href="#tuning-and-auto-scaling"></a>
</h2>
<p>As explained above, <code>push()</code>, <code>pop()</code>, and
<code>wait()</code> launch new workers to run tasks. The number of new
workers depends on the number of tasks at the time. In addition, workers
can shut themselves down as work completes. In other words,
<code>crew</code> automatically raises and lowers the number of workers
in response to fluctuations in the task workload.</p>
<p>The most useful arguments for down-scaling, in order of importance,
are:</p>
<ol style="list-style-type: decimal">
<li>
<code>seconds_idle</code>: shut down a worker if it spends too long
waiting for a task.</li>
<li>
<code>tasks_max</code>: shut down a worker after it completes a
certain number of tasks.</li>
<li>
<code>seconds_wall</code>: soft wall time of a worker.</li>
</ol>
<p>Please tune these these arguments to achieve the desired balance for
auto-scaling. The two extremes of auto-scaling are <a href="https://mschubert.github.io/clustermq/" class="external-link"><code>clustermq</code></a>-like
<em>persistent workers</em> and <a href="https://future.futureverse.org/" class="external-link"><code>future</code></a>-like
<em>transient workers</em>, and each is problematic in its own way.</p>
<ol style="list-style-type: decimal">
<li>
<em>Persistent workers</em>: a persistent worker launches once,
typically runs many tasks, and stays running for the entire lifetime of
the controller. Persistent workers minimize overhead and quickly
complete large numbers of short tasks. However, they risk spending too
much time in an idle state if there are no tasks to run. Excessive
idling wastes resources, which could impact your colleagues on a shared
cluster or drive up costs on Amazon Web Services.</li>
<li>
<em>Transient workers</em>: a transient worker terminates as soon as
it completes a single task. Each subsequent task requires a new
transient worker to run it. Transient workers avoid excessive idling,
but frequent worker launches cause significant overhead and slows down
the computation as a whole.</li>
</ol>
</div>
<div class="section level2">
<h2 id="asynchronous-management-of-workers">Asynchronous management of workers<a class="anchor" aria-label="anchor" href="#asynchronous-management-of-workers"></a>
</h2>
<p>Some launchers support local processes to launch and terminate
workers asynchronously. For example, a cloud-based launcher may need to
make HTTP requests to launch and terminate workers on e.g. AWS Batch,
and these time-consuming requests should happen in the background.
Controllers that support this will have a <code>processes</code>
argument to specify the number of local R processes to churn through
worker launches and terminations. Set <code>processes = NULL</code> to
disable async, which can be helpful for troubleshooting.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by William Michael Landau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
