<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="crew">
<title>Launcher plugins â€¢ crew</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Launcher plugins">
<meta property="og:description" content="crew">
<meta property="og:image" content="https://wlandau.github.io/crew/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">crew</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>How to use `crew`</h6>
    <a class="dropdown-item" href="../articles/introduction.html">Introduction to crew</a>
    <a class="dropdown-item" href="../articles/groups.html">Controller groups</a>
    <a class="dropdown-item" href="../articles/shiny.html">Asynchronous Shiny apps</a>
    <a class="dropdown-item" href="../articles/promises.html">Integration with promises</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Technical details</h6>
    <a class="dropdown-item" href="../articles/plugins.html">Launcher plugins</a>
    <a class="dropdown-item" href="../articles/risks.html">Known risks of crew</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/wlandau/crew/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Launcher plugins</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/wlandau/crew/blob/HEAD/vignettes/plugins.Rmd" class="external-link"><code>vignettes/plugins.Rmd</code></a></small>
      <div class="d-none name"><code>plugins.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="about">About<a class="anchor" aria-label="anchor" href="#about"></a>
</h2>
<p><code>crew</code> lets users write custom <a href="https://wlandau.github.io/crew/reference/crew_class_launcher.html">launchers</a>
for different types of workers that connect over the local network. The
<a href="https://wlandau.github.io/crew.cluster/"><code>crew.cluster</code></a>
package already has plugins for traditional high-performance computing
schedulers (<a href="https://slurm.schedmd.com/" class="external-link">SLURM</a>, SGE, LSF,
and PBS/TORQUE).</p>
</div>
<div class="section level2">
<h2 id="request-for-community-contributions">ðŸ“£ Request for community contributions ðŸ“£<a class="anchor" aria-label="anchor" href="#request-for-community-contributions"></a>
</h2>
<p><span style="color: blue"><strong>The launcher plugin framework aims
to extend <code>crew</code> to modern platforms and services like <a href="https://cloud.google.com/run/" class="external-link">Google Cloud Run</a>, <a href="https://kubernetes.io/" class="external-link">Kubernetes</a>, and beyond. At the time of
writing, plugins for cloud computing do not yet exist. So if you have
access to these services and know how to use them, please consider
contributing a package with plugins of your own. The maintainer of
<code>crew</code> would love to work with you!</strong></span></p>
</div>
<div class="section level2">
<h2 id="how-it-works">How it works<a class="anchor" aria-label="anchor" href="#how-it-works"></a>
</h2>
<p>These <a href="https://wlandau.github.io/crew/reference/crew_class_launcher.html">launcher</a>
plugins need not become part of the <code>crew</code> package itself.
You can write your plugin in a simple R script, or you write it in a
custom R package that <a href="https://r-pkgs.org/dependencies-in-practice.html" class="external-link">depends on</a>
<code>crew</code>. Published packages with <a href="https://wlandau.github.io/crew/reference/crew_class_launcher.html">launcher</a>
plugins are powerful extensions that enhance <code>crew</code> for the
entire open-source community. See <a href="https://r-pkgs.org/" class="external-link">R
Packages</a> by <a href="https://hadley.nz/" class="external-link">Hadley Wickham</a> and <a href="https://jennybryan.org/" class="external-link">Jenny Bryan</a> for how to write an R
package.</p>
</div>
<div class="section level2">
<h2 id="scope">Scope<a class="anchor" aria-label="anchor" href="#scope"></a>
</h2>
<p>This vignette demonstrates how to write a <code>crew</code> launcher
plugin. It assumes prior familiarity with <a href="https://r6.r-lib.org/articles/Introduction.html" class="external-link"><code>R6</code>
classes</a> and the computing platform of your plugin.</p>
</div>
<div class="section level2">
<h2 id="implementation">Implementation<a class="anchor" aria-label="anchor" href="#implementation"></a>
</h2>
<p>To create your own launcher plugin, write an <a href="https://r6.r-lib.org/articles/Introduction.html" class="external-link"><code>R6</code></a>
subclass of <a href="https://wlandau.github.io/crew/reference/crew_class_launcher.html"><code>crew_class_launcher</code></a>
with a <a href="https://wlandau.github.io/crew/reference/crew_class_launcher_local.html#method-launch-worker-"><code>launch_worker()</code></a>
method analogous the one in the <a href="https://wlandau.github.io/crew/reference/crew_class_launcher_local.html">local
process launcher</a>. <code>launch_worker()</code> must accept the same
arguments as the <a href="https://wlandau.github.io/crew/reference/crew_class_launcher_local.html#method-launch-worker-">local
process <code>launch_worker()</code> method</a>, generate a call to <a href="https://wlandau.github.io/crew/reference/crew_worker.html"><code>crew_worker()</code></a>,
and then submit a new job or process to run that call.</p>
</div>
<div class="section level2">
<h2 id="network">Network<a class="anchor" aria-label="anchor" href="#network"></a>
</h2>
<p>Each worker that launches must be able to dial into the client over
the local network. The <code>host</code> argument of
<code><a href="../reference/crew_client.html">crew_client()</a></code> provides the local IP address, and the
<code>port</code> argument provides the TCP port. The controller helper
function (see below) should expose arguments <code>host</code> and
<code>port</code> in order to solve potential network problems like <a href="https://github.com/wlandau/crew.cluster/issues/1#issuecomment-1546024163" class="external-link">this
one</a>.</p>
<p>By default, <code>host</code> is the local IP address.
<code>crew</code> assumes the local network is secure. Please take the
time to assess the network security risks of your computing environment.
Use at your own risk.</p>
</div>
<div class="section level2">
<h2 id="termination">Termination<a class="anchor" aria-label="anchor" href="#termination"></a>
</h2>
<p>We recommend you implement an optional <a href="https://wlandau.github.io/crew/reference/crew_class_launcher_local.html#method-terminate-worker-"><code>terminate_worker()</code></a>
method. Although <code>mirai</code> has its own way of terminating
workers, it only works if the worker already connected, and it cannot
reach workers that fail to connect and hang in a crashed state. An
optional <a href="https://wlandau.github.io/crew/reference/crew_class_launcher_local.html#method-terminate-worker-"><code>terminate_worker()</code></a>
method in your <code>crew</code> launcher plugin is extra assurance that
these workers will exit.</p>
<p>If you implement a custom <a href="https://wlandau.github.io/crew/reference/crew_class_launcher_local.html#method-terminate-worker-"><code>terminate_worker()</code></a>
method, it must not throw an error (and should not throw a warning or
message) if the worker is already terminated. In addition, it must
accept a handle that identifies the worker, and this handle must be the
return value of the previous call to <a href="https://wlandau.github.io/crew/reference/crew_class_launcher_local.html#method-launch-worker-"><code>launch_worker()</code></a>.
A handle can be any kind of R object: a process ID, a job name, an
<code>R6</code> object returned by <code><a href="https://callr.r-lib.org/reference/r_bg.html" class="external-link">callr::r_bg()</a></code>, etc.</p>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>The following is a custom custom launcher class whose workers are
local R processes on Unix-like systems.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_launcher_class</span> <span class="op">&lt;-</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"custom_launcher_class"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">crew</span><span class="fu">::</span><span class="va"><a href="../reference/crew_class_launcher.html">crew_class_launcher</a></span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    launch_worker <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">call</span>, <span class="va">name</span>, <span class="va">launcher</span>, <span class="va">worker</span>, <span class="va">instance</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Rhome.html" class="external-link">R.home</a></span><span class="op">(</span><span class="st">"bin"</span><span class="op">)</span>, <span class="st">"R"</span><span class="op">)</span></span>
<span>      <span class="fu">processx</span><span class="fu">::</span><span class="va"><a href="http://processx.r-lib.org/reference/process.html" class="external-link">process</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>        command <span class="op">=</span> <span class="va">bin</span>,</span>
<span>        args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"-e"</span>, <span class="va">call</span><span class="op">)</span>,</span>
<span>        cleanup <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    terminate_worker <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">handle</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">handle</span><span class="op">$</span><span class="fu">signal</span><span class="op">(</span><span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_terminate_signal.html">crew_terminate_signal</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inside <code>launch_worker()</code>, the
<code>processx::process$new(command = bin, args = c("-e", call))</code>
line runs the <a href="https://wlandau.github.io/crew/reference/crew_worker.html"><code>crew_worker()</code></a>
call in an external R process. This process runs in the background,
connects back to <code>crew</code> and <code>mirai</code> over the local
network, and accepts the tasks you push to the controller.
<code>processx::process$new()</code> also returns a handle which the
<code>terminate_worker()</code> method can use to force-terminate the
process if appropriate. <code>mirai</code> has its own way to terminate
workers, so a <code>terminate_worker()</code> method is not strictly
required, but it is a useful safeguard in case a worker hangs in a
crashed state before it establishes a connection.</p>
<p>Every <code>launch_worker()</code> method must accept arguments
<code>call</code>, <code>launcher</code>, <code>worker</code>, and
<code>instance</code>. The method does not actually need to use all
these arguments, but they must be present in the function signature.</p>
<ul>
<li>
<code>call</code>: text string with a call to <a href="https://wlandau.github.io/crew/reference/crew_worker.html"><code>crew_worker()</code></a>.</li>
<li>
<code>name</code>: text string with an informative name for the
worker instance.</li>
<li>
<code>launcher</code>: text string with the name of the
launcher.</li>
<li>
<code>worker</code>: positive integer index of the worker. Ranges
from 1 to the maximum number of simultaneous workers configured for the
controller.</li>
<li>
<code>instance</code>: text string with the instance of the worker
in the launcher at the given worker index.</li>
</ul>
<p>To see what the <code>call</code> object looks like, create a new
launcher and run the <code><a href="https://rdrr.io/r/base/call.html" class="external-link">call()</a></code> method.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wlandau.github.io/crew/">crew</a></span><span class="op">)</span></span>
<span><span class="va">launcher</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/crew_launcher_local.html">crew_launcher_local</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">launcher</span><span class="op">$</span><span class="fu">call</span><span class="op">(</span></span>
<span>  socket <span class="op">=</span> <span class="st">"ws://127.0.0.1:5000/3/aa9c59ea"</span>,</span>
<span>  launcher <span class="op">=</span> <span class="st">"my_launcher"</span>,</span>
<span>  worker <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>  instance <span class="op">=</span> <span class="st">"aa9c59ea"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "crew::crew_worker(settings = list(url = \"ws://127.0.0.1:5000/3/aa9c59ea\", autoexit = 15L, cleanup = 1L, output = TRUE, maxtasks = Inf, idletime = Inf, walltime = Inf, timerstart = 0L, tls = NULL, rs = NULL), launcher = \"my_launcher\", worker = 3L, instance = \"aa9c59ea\")"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="helper">Helper<a class="anchor" aria-label="anchor" href="#helper"></a>
</h2>
<p>It is useful to have a helper function that creates controllers with
your custom launcher. It should:</p>
<ol style="list-style-type: decimal">
<li>Accept all the same arguments as <a href="https://wlandau.github.io/crew/reference/crew_controller_local.html"><code>crew_controller_local()</code></a>.</li>
<li>Create a client object using <a href="https://wlandau.github.io/crew/reference/crew_client.html"><code>crew_client()</code></a>.</li>
<li>Create a launcher object with the <a href="https://wlandau.github.io/crew/reference/crew_class_launcher.html#method-crew_class_launcher-new"><code>new()</code>
method</a> of your custom launcher class.</li>
<li>Create a new controller using <a href="https://wlandau.github.io/crew/reference/crew_controller.html"><code>crew_controller()</code></a>.</li>
<li>Scan the controller for obvious errors using the <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html#method-crew_class_controller-validate"><code>validate()</code></a>
method of the controller.</li>
</ol>
<p>Feel free to borrow from the <a href="https://github.com/wlandau/crew/blob/main/R/crew_controller_local.R" class="external-link"><code>crew_controller_local()</code>
source code</a>. For packages, you can use the
<code>@inheritParams</code> <a href="https://roxygen2.r-lib.org/" class="external-link"><code>roxygen2</code></a> tag to
inherit the documentation of all the arguments instead of writing it by
hand. You may want to adjust the default arguments based on the
specifics of your platform, especially <code>seconds_launch</code> if
workers take a long time to launch.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @title Create a controller with the custom launcher.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#' @description Create an `R6` object to submit tasks and</span></span>
<span><span class="co">#'   launch workers.</span></span>
<span><span class="co">#' @inheritParams crew::crew_controller_local</span></span>
<span><span class="va">crew_controller_custom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">name</span> <span class="op">=</span> <span class="st">"custom controller name"</span>,</span>
<span>  <span class="va">workers</span> <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  <span class="va">host</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">port</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">tls</span> <span class="op">=</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_tls.html">crew_tls</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">seconds_interval</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  <span class="va">seconds_timeout</span> <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  <span class="va">seconds_launch</span> <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  <span class="va">seconds_idle</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="va">seconds_wall</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="va">tasks_max</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="va">tasks_timers</span> <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>  <span class="va">reset_globals</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">reset_packages</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">reset_options</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">garbage_collection</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">launch_max</span> <span class="op">=</span> <span class="fl">5L</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">client</span> <span class="op">&lt;-</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_client.html">crew_client</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">name</span>,</span>
<span>    workers <span class="op">=</span> <span class="va">workers</span>,</span>
<span>    host <span class="op">=</span> <span class="va">host</span>,</span>
<span>    port <span class="op">=</span> <span class="va">port</span>,</span>
<span>    tls <span class="op">=</span> <span class="va">tls</span>,</span>
<span>    seconds_interval <span class="op">=</span> <span class="va">seconds_interval</span>,</span>
<span>    seconds_timeout <span class="op">=</span> <span class="va">seconds_timeout</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">launcher</span> <span class="op">&lt;-</span> <span class="va">custom_launcher_class</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">name</span>,</span>
<span>    seconds_interval <span class="op">=</span> <span class="va">seconds_interval</span>,</span>
<span>    seconds_timeout <span class="op">=</span> <span class="va">seconds_timeout</span>,</span>
<span>    seconds_launch <span class="op">=</span> <span class="va">seconds_launch</span>,</span>
<span>    seconds_idle <span class="op">=</span> <span class="va">seconds_idle</span>,</span>
<span>    seconds_wall <span class="op">=</span> <span class="va">seconds_wall</span>,</span>
<span>    tasks_max <span class="op">=</span> <span class="va">tasks_max</span>,</span>
<span>    tasks_timers <span class="op">=</span> <span class="va">tasks_timers</span>,</span>
<span>    reset_globals <span class="op">=</span> <span class="va">reset_globals</span>,</span>
<span>    reset_packages <span class="op">=</span> <span class="va">reset_packages</span>,</span>
<span>    reset_options <span class="op">=</span> <span class="va">reset_options</span>,</span>
<span>    garbage_collection <span class="op">=</span> <span class="va">garbage_collection</span>,</span>
<span>    launch_max <span class="op">=</span> <span class="va">launch_max</span>,</span>
<span>    tls <span class="op">=</span> <span class="va">tls</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_controller.html">crew_controller</a></span><span class="op">(</span>client <span class="op">=</span> <span class="va">client</span>, launcher <span class="op">=</span> <span class="va">launcher</span><span class="op">)</span></span>
<span>  <span class="va">controller</span><span class="op">$</span><span class="fu">validate</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">controller</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="informal-testing">Informal testing<a class="anchor" aria-label="anchor" href="#informal-testing"></a>
</h2>
<p>Before you begin testing, please begin monitoring local processes and
remote jobs on your platform. In the case of the above <code>crew</code>
launcher which only creates local processes, it is sufficient to start
<a href="https://htop.dev/" class="external-link"><code>htop</code></a> and filter for R
processes, or launch a new R session to monitor the process table from
<a href="https://ps.r-lib.org/reference/ps.html" class="external-link"><code>ps::ps()</code></a>.
However, for more ambitious launchers that submit workers to e.g.Â <a href="https://aws.amazon.com/batch/" class="external-link">AWS Batch</a>, you may need to open
the <a href="https://aws.amazon.com/cloudwatch/" class="external-link">CloudWatch</a>
dashboard, then view the AWS billing dashboard after testing.</p>
<p>When you are ready to begin testing, try out the example in the <a href="https://wlandau.github.io/crew/index.html#usage">README</a>, but
use your your custom controller helper instead of <a href="https://wlandau.github.io/crew/reference/crew_controller_local.html"><code>crew_controller_local()</code></a>.</p>
<p>First, create and start a controller. You may wish to monitor local
processes on your computer to make sure the <code>mirai</code>
dispatcher starts.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wlandau.github.io/crew/">crew</a></span><span class="op">)</span></span>
<span><span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu">crew_controller_custom</span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Try pushing a task that gets the local IP address and process ID of
the worker instance.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"get worker IP address and process ID"</span>,</span>
<span>  command <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu">getip</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/getip/man/getip.html" class="external-link">getip</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"local"</span><span class="op">)</span>, <span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_pid.html" class="external-link">ps_pid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Wait for the task to complete and look at the result.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "192.168.0.2 27336"</span></span></code></pre></div>
<p>Please use the result to verify that the task really ran on a worker
as intended. The process ID above should agree with the one from the
handle (<a href="https://github.com/r-lib/processx/issues/364" class="external-link">except on
Windows</a> because the actual R process may be different from the
<code>R.exe</code> process created first). In addition, if the worker is
running on a different computer, the worker IP address should be
different than the local IP address. Since our custom launcher creates
local processes, the IP addresses are the same in this case, but they
should be different for a <a href="https://slurm.schedmd.com/" class="external-link">SLURM</a>
or <a href="https://aws.amazon.com/batch/" class="external-link">AWS Batch</a> launcher.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">getip</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/getip/man/getip.html" class="external-link">getip</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"local"</span><span class="op">)</span></span>
<span><span class="co">#&gt; "192.168.0.2"</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="va">launcher</span><span class="op">$</span><span class="va">workers</span><span class="op">$</span><span class="va">handle</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">get_pid</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 27336</span></span></code></pre></div>
<p>If you did not set any timeouts or task limits, the worker that ran
the task should still be online. The other worker had no tasks, so it
did not need to launch.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="va">client</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 Ã— 6</span></span>
<span><span class="co">#&gt;   worker online instances assigned complete socket</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;lgl&gt;      &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1      1 TRUE           1        1        1 ws://10.0.0.32:50258/1/571bcda7â€¦</span></span>
<span><span class="co">#&gt; 2      2 FALSE          0        0        0 ws://10.0.0.32:50258/2/daf88d6eâ€¦</span></span></code></pre></div>
<p>When you are done, terminate the controller. This terminates the
<code>mirai</code> dispatcher process and the <code>crew</code>
workers.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controller</span><span class="op">$</span><span class="fu">terminate</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Finally, use the process monitoring interface of your computing
platform or operating system to verify that all <code>mirai</code>
dispatchers and <code>crew</code> workers are terminated.</p>
</div>
<div class="section level2">
<h2 id="load-testing">Load testing<a class="anchor" aria-label="anchor" href="#load-testing"></a>
</h2>
<p>If the informal testing succeeded, we recommend you scale up testing
to more ambitious scenarios. As one example, you can test that your
workers can auto-scale and quickly churn through a large number of
tasks.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wlandau.github.io/crew/">crew</a></span><span class="op">)</span></span>
<span><span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu">crew_controller_custom</span><span class="op">(</span></span>
<span>  seconds_idle <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>  workers <span class="op">=</span> <span class="fl">2L</span></span>
<span><span class="op">)</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Push 100 tasks</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">index</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">100L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"task_"</span>, <span class="va">index</span><span class="op">)</span></span>
<span>  <span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span>, command <span class="op">=</span> <span class="va">index</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"push"</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Wait for the tasks to complete.</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Wait for the workers to idle out and exit on their own.</span></span>
<span><span class="fu"><a href="../reference/crew_retry.html">crew_retry</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">controller</span><span class="op">$</span><span class="va">client</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">online</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  seconds_interval <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  seconds_timeout <span class="op">=</span> <span class="fl">60</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Do the same for 100 more tasks.</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">index</span> <span class="kw">in</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">100L</span><span class="op">)</span> <span class="op">+</span> <span class="fl">100L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"task_"</span>, <span class="va">index</span><span class="op">)</span></span>
<span>  <span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span>, command <span class="op">=</span> <span class="va">index</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"push"</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/crew_retry.html">crew_retry</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">controller</span><span class="op">$</span><span class="va">client</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">online</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  seconds_interval <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  seconds_timeout <span class="op">=</span> <span class="fl">60</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Collect the results.</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span>scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">bind_rows</span><span class="op">(</span><span class="va">results</span>, <span class="va">result</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Check the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">200L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co"># View worker and task summaries.</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="va">schedule</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="va">launcher</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="va">schedule</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Terminate the controller.</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">terminate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Now outside crew, verify that the mirai dispatcher</span></span>
<span><span class="co"># and crew workers successfully terminated.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="asynchrony">Asynchrony<a class="anchor" aria-label="anchor" href="#asynchrony"></a>
</h2>
<p>Depending on the launcher plugin, worker launches and terminations
can be time-consuming. For example, each HTTP request to AWS Batch can
take a couple seconds, and this latency becomes burdensome when it there
are hundreds of workers. Fortunately, <code>crew</code> launchers can
run launches and terminations asynchronously. As a launcher plugin
developer, all you need to do is:</p>
<ol style="list-style-type: decimal">
<li>Expose the <code>processes</code> argument of
<code>launcher$new()</code>. The <code>processes</code> field sets how
many <code>mirai</code> daemons run locally and churn through quick
requests.</li>
<li>Execute launches and terminations inside
<code>self$async$eval()</code>, and return the resulting value from
<code>launch_worker()</code> and <code>terminate_worker()</code>.</li>
</ol>
<p>Letâ€™s demonstrate on the simple <code>processx</code> example. The
use case itself may silly because the workers are local
<code>processx</code> processes, but the same principles apply if you
replace <code>processx</code> with a cloud computing service like AWS
Batch and you replace the process IDs with AWS Batch job IDs.</p>
<p>Here is what the launcher class looks like. We work with
<code>processx</code> PIDs directly because they are light and easy to
send to local async <code>mirai</code> daemons. The
<code>self$async$eval()</code> function accepts R code, data, and
packages to run a quick local asynchronous task, and it returns a
<code><a href="https://shikokuchuo.net/mirai/reference/mirai.html" class="external-link">mirai::mirai()</a></code> task object as the handle.
<code>handle$data</code> returns the results if available, and
<code>crew</code> uses <code><a href="https://shikokuchuo.net/mirai/reference/call_mirai.html" class="external-link">mirai::call_mirai()</a></code> to make sure any
tasks submitted by <code>launch_worker()</code> have resolved before
they are used by <code>terminate_worker()</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">async_launcher_class</span> <span class="op">&lt;-</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"custom_launcher_class"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">crew</span><span class="fu">::</span><span class="va"><a href="../reference/crew_class_launcher.html">crew_class_launcher</a></span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    launch_worker <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">call</span>, <span class="va">name</span>, <span class="va">launcher</span>, <span class="va">worker</span>, <span class="va">instance</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">async</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span></span>
<span>        command <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pid <span class="op">=</span> <span class="va">process</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">bin</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"-e"</span>, <span class="va">call</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">get_pid</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Rhome.html" class="external-link">R.home</a></span><span class="op">(</span><span class="st">"bin"</span><span class="op">)</span>, <span class="st">"R"</span><span class="op">)</span>, call <span class="op">=</span> <span class="va">call</span><span class="op">)</span>,</span>
<span>        packages <span class="op">=</span> <span class="st">"processx"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    terminate_worker <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">handle</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">async</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span></span>
<span>        command <span class="op">=</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_terminate_process.html">crew_terminate_process</a></span><span class="op">(</span><span class="va">handle</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">pid</span><span class="op">)</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pid <span class="op">=</span> <span class="va">handle</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">pid</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The controller helper includes a <code>processes</code> argument
which sets how many asynchronous <code>mirai</code> daemons to create.
Set <code>processes</code> to <code>NULL</code> to disable async and use
it like an ordinary synchronous controller.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">crew_controller_async</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">name</span> <span class="op">=</span> <span class="st">"async controller name"</span>,</span>
<span>  <span class="va">workers</span> <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  <span class="va">host</span> <span class="op">=</span> <span class="st">"127.0.0.1"</span>,</span>
<span>  <span class="va">port</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">tls</span> <span class="op">=</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_tls.html">crew_tls</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>,</span>
<span>  <span class="va">seconds_interval</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  <span class="va">seconds_timeout</span> <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  <span class="va">seconds_launch</span> <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  <span class="va">seconds_idle</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="va">seconds_wall</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="va">tasks_max</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="va">tasks_timers</span> <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>  <span class="va">reset_globals</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">reset_packages</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">reset_options</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">garbage_collection</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">launch_max</span> <span class="op">=</span> <span class="fl">5L</span>,</span>
<span>  <span class="va">processes</span> <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># Number of local async daemons for worker launches etc.</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">client</span> <span class="op">&lt;-</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_client.html">crew_client</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">name</span>,</span>
<span>    workers <span class="op">=</span> <span class="va">workers</span>,</span>
<span>    host <span class="op">=</span> <span class="va">host</span>,</span>
<span>    port <span class="op">=</span> <span class="va">port</span>,</span>
<span>    tls <span class="op">=</span> <span class="va">tls</span>,</span>
<span>    seconds_interval <span class="op">=</span> <span class="va">seconds_interval</span>,</span>
<span>    seconds_timeout <span class="op">=</span> <span class="va">seconds_timeout</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">launcher</span> <span class="op">&lt;-</span> <span class="va">async_launcher_class</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">name</span>,</span>
<span>    seconds_interval <span class="op">=</span> <span class="va">seconds_interval</span>,</span>
<span>    seconds_launch <span class="op">=</span> <span class="va">seconds_launch</span>,</span>
<span>    seconds_idle <span class="op">=</span> <span class="va">seconds_idle</span>,</span>
<span>    seconds_wall <span class="op">=</span> <span class="va">seconds_wall</span>,</span>
<span>    tasks_max <span class="op">=</span> <span class="va">tasks_max</span>,</span>
<span>    tasks_timers <span class="op">=</span> <span class="va">tasks_timers</span>,</span>
<span>    reset_globals <span class="op">=</span> <span class="va">reset_globals</span>,</span>
<span>    reset_packages <span class="op">=</span> <span class="va">reset_packages</span>,</span>
<span>    reset_options <span class="op">=</span> <span class="va">reset_options</span>,</span>
<span>    garbage_collection <span class="op">=</span> <span class="va">garbage_collection</span>,</span>
<span>    launch_max <span class="op">=</span> <span class="va">launch_max</span>,</span>
<span>    tls <span class="op">=</span> <span class="va">tls</span>,</span>
<span>    processes <span class="op">=</span> <span class="va">processes</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_controller.html">crew_controller</a></span><span class="op">(</span></span>
<span>    client <span class="op">=</span> <span class="va">client</span>,</span>
<span>    launcher <span class="op">=</span> <span class="va">launcher</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">controller</span><span class="op">$</span><span class="fu">validate</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">controller</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Creating a controller is the same as before, except the user sets
both the <code>workers</code> and <code>processes</code> arguments.
Remember, these are two different things: <code>workers</code> is the
number of serious workers that run serious tasks from
<code>push()</code>, whereas <code>processes</code> is the number of
<code>mirai</code> daemons that asynchronously launch and terminate
those serious workers. Workers may or may not be local, but
<code>processes</code> are always local.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">async_controller</span> <span class="op">&lt;-</span> <span class="fu">crew_controller_async</span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">12</span>, processes <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><code>async_controller$start()</code> automatically launches 4 local
processes to asynchronously auto-scale the workers, and
<code>async_controller$terminate()</code> automatically shuts down those
4 processes. Beyond that, usage is the exactly same as before.</p>
</div>
<div class="section level2">
<h2 id="managing-workers">Managing workers<a class="anchor" aria-label="anchor" href="#managing-workers"></a>
</h2>
<p>Usually <code>crew</code> workers terminate themselves when the
parent R session exits or the controller terminates, but under rare
circumstances they may continue running. To help users of your plugin
monitor and manually terminate workers, please consider implementing job
management utilities to go with your launcher plugin. As described in
the <a href="https://wlandau.github.io/crew/articles/introduction.html">introduction
vignette</a>, <code><a href="../reference/crew_monitor_local.html">crew_monitor_local()</a></code> helps manually list and
terminate local processes relevant to <code>crew</code>. Source code for
the local monitor is <a href="https://github.com/wlandau/crew/blob/main/R/crew_monitor_local.R" class="external-link">on
GitHub</a>, methods are <a href="https://wlandau.github.io/crew/reference/crew_class_monitor_local.html">documented
in the package website</a>, and example usage is in the <a href="https://wlandau.github.io/crew/articles/introduction.html">introduction
vignette</a>. In addition, <a href="https://wlandau.github.io/crew.aws.batch/reference/crew_monitor_aws_batch.html"><code>crew_monitor_aws_batch()</code></a>
implements <a href="https://wlandau.github.io/crew.aws.batch/reference/crew_class_monitor_aws_batch.html">several
methods</a> for listing and terminating AWS Batch jobs, as well as
viewing CloudWatch logs.</p>
<p>The source code for the local monitor is copied below:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">crew_monitor_local</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va"><a href="../reference/crew_class_monitor_local.html">crew_class_monitor_local</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">crew_class_monitor_local</span> <span class="op">&lt;-</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"crew_class_monitor_local"</span>,</span>
<span>  cloneable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    dispatchers <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">crew_monitor_pids</span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"mirai::dispatcher"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    daemons <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">crew_monitor_pids</span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"mirai::daemon"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    workers <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">crew_monitor_pids</span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"crew::crew_worker"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    terminate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pids</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">pids</span><span class="op">)</span>, <span class="fu">crew</span><span class="fu">::</span><span class="va"><a href="../reference/crew_terminate_process.html">crew_terminate_process</a></span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">crew_monitor_pids</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pattern</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">processes</span> <span class="op">&lt;-</span> <span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps.html" class="external-link">ps</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">commands</span> <span class="op">&lt;-</span> <span class="fu">map</span><span class="op">(</span></span>
<span>    <span class="va">processes</span><span class="op">$</span><span class="va">ps_handle</span>,</span>
<span>    <span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="fu">ps</span><span class="fu">::</span><span class="fu"><a href="https://ps.r-lib.org/reference/ps_cmdline.html" class="external-link">ps_cmdline</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">condition</span><span class="op">)</span> <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="va">pattern</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">commands</span><span class="op">)</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">processes</span><span class="op">$</span><span class="va">pid</span><span class="op">[</span><span class="va">filter</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Example usage:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">monitor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/crew_monitor_local.html">crew_monitor_local</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">dispatchers</span><span class="op">(</span><span class="op">)</span> <span class="co"># List PIDs of all local {mirai} dispatcher processes.</span></span>
<span><span class="co">#&gt; [1] 31215</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">daemons</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">workers</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 57001 57002</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">terminate</span><span class="op">(</span>pid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">57001</span>, <span class="fl">57002</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">workers</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by William Michael Landau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
