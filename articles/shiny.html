<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="crew">
<title>Asynchronous Shiny apps â€¢ crew</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Asynchronous Shiny apps">
<meta property="og:description" content="crew">
<meta property="og:image" content="https://wlandau.github.io/crew/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">crew</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>How to use `crew`</h6>
    <a class="dropdown-item" href="../articles/introduction.html">Introduction to crew</a>
    <a class="dropdown-item" href="../articles/groups.html">Controller groups</a>
    <a class="dropdown-item" href="../articles/shiny.html">Asynchronous Shiny apps</a>
    <a class="dropdown-item" href="../articles/promises.html">Integration with promises</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Technical details</h6>
    <a class="dropdown-item" href="../articles/plugins.html">Launcher plugins</a>
    <a class="dropdown-item" href="../articles/risks.html">Known risks of crew</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/wlandau/crew/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Asynchronous Shiny apps</h1>
                        <h4 data-toc-skip class="author">Will Landau and
Daniel Woodie</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/wlandau/crew/blob/HEAD/vignettes/shiny.Rmd" class="external-link"><code>vignettes/shiny.Rmd</code></a></small>
      <div class="d-none name"><code>shiny.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="about">About<a class="anchor" aria-label="anchor" href="#about"></a>
</h2>
<p><code>crew</code> is efficient to use in Shiny apps, and the <a href="https://wlandau.github.io/crew/reference/crew_class_controller.html">centralized
controller</a> makes the programming easy, even if there are thousands
of tasks.</p>
<p>This vignette shows two versions of an example app. The first version
is simple to code but choppily. The second version feels snappier
because it uses integration between <a href="https://rstudio.github.io/promises/" class="external-link"><code>promises</code></a> and
<a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a>.</p>
</div>
<div class="section level2">
<h2 id="example-coin-flips-no-promises">Example: coin flips, no promises<a class="anchor" aria-label="anchor" href="#example-coin-flips-no-promises"></a>
</h2>
<p>This app simulates thousands of coin flips to determine if a coin is
fair. Each coin flip is a task, and <code>crew</code> runs the tasks in
parallel. When you run the app, the clock keeps ticking even while coin
flips are running. In other words, parallel tasks run in the background
and the app stays interactive.</p>
<p><a href="https://vimeo.com/954101902" class="external-link"><img src="figures/coins.png"></a></p>
<div class="section level3">
<h3 id="tutorial">Tutorial<a class="anchor" aria-label="anchor" href="#tutorial"></a>
</h3>
<p>We first load Shiny.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span></code></pre></div>
<p>The <code>flip_coin()</code> function simulates a coin flip: wait 0.1
seconds, then randomly return 1 for heads or 0 for tails. After many
flips, the user may deduce that the coin is slightly unfair.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flip_coin</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.501</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The UI has a button to flip coins and a text output for results.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>  <span class="fu">div</span><span class="op">(</span><span class="st">"Is the coin fair?"</span><span class="op">)</span>,</span>
<span>  <span class="fu">actionButton</span><span class="op">(</span><span class="st">"button"</span>, <span class="st">"Flip 1000 coins"</span><span class="op">)</span>,</span>
<span>  <span class="fu">textOutput</span><span class="op">(</span><span class="st">"results"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In the server, we start by creating a <code>crew</code> controller
which will simulate coin flips in parallel across 10 parallel workers.
<code>seconds_idle = 10</code> means each worker automatically exits if
it idles for 10 seconds.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  controller <span class="ot">&lt;-</span> crew<span class="sc">::</span><span class="fu">crew_controller_local</span>(<span class="at">workers =</span> <span class="dv">10</span>, <span class="at">seconds_idle =</span> <span class="dv">10</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  controller<span class="sc">$</span><span class="fu">start</span>()</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="fu">onStop</span>(<span class="cf">function</span>() controller<span class="sc">$</span><span class="fu">terminate</span>())</span></code></pre></div>
<p>We keep running totals of heads, tails, and total flips.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">flips</span> <span class="op">&lt;-</span> <span class="fu">reactiveValues</span><span class="op">(</span>heads <span class="op">=</span> <span class="fl">0</span>, tails <span class="op">=</span> <span class="fl">0</span>, total <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>The action button submits a batch of 1000 coin flips.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">button</span>, <span class="op">{</span></span>
<span>    <span class="va">controller</span><span class="op">$</span><span class="fu">walk</span><span class="op">(</span></span>
<span>      command <span class="op">=</span> <span class="fu">flip_coin</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      iterate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>flip_coin <span class="op">=</span> <span class="va">flip_coin</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We include an <code>observe()</code> statement to watch for finished
coin flips and update the totals every 0.5 seconds.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">invalidateLater</span><span class="op">(</span>millis <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">collect</span><span class="op">(</span>error <span class="op">=</span> <span class="st">"stop"</span><span class="op">)</span></span>
<span>    <span class="fu">req</span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>    <span class="va">new_flips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span>    <span class="va">flips</span><span class="op">$</span><span class="va">heads</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">heads</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span></span>
<span>    <span class="va">flips</span><span class="op">$</span><span class="va">tails</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">tails</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">new_flips</span><span class="op">)</span></span>
<span>    <span class="va">flips</span><span class="op">$</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">total</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Finally, our text output refreshes every 0.5 seconds to update the
clock and the totals.</p>
<p>A text output refreshes to show the current time and the number of
coin flips submitted but not yet completed. The refresh happens when a
batch of coin flips is submitted, a coin flip completes, or a full
second has passed.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>  output<span class="sc">$</span>results <span class="ot">&lt;-</span> <span class="fu">renderText</span>({</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="fu">invalidateLater</span>(<span class="at">millis =</span> <span class="dv">500</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    pattern <span class="ot">&lt;-</span> <span class="st">"%s | %s heads, %s tails, %s total"</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    time <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%H:%M:%S"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    <span class="fu">sprintf</span>(pattern, time, flips<span class="sc">$</span>heads, flips<span class="sc">$</span>tails, flips<span class="sc">$</span>total)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  })</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="full-app-code">Full app code<a class="anchor" aria-label="anchor" href="#full-app-code"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">flip_coin</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.55</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>  <span class="fu">div</span><span class="op">(</span><span class="st">"Is the coin fair?"</span><span class="op">)</span>,</span>
<span>  <span class="fu">actionButton</span><span class="op">(</span><span class="st">"button"</span>, <span class="st">"Flip 1000 coins"</span><span class="op">)</span>,</span>
<span>  <span class="fu">textOutput</span><span class="op">(</span><span class="st">"results"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># crew controller</span></span>
<span>  <span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_controller_local.html">crew_controller_local</a></span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">10</span>, seconds_idle <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="va">controller</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">onStop</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">controller</span><span class="op">$</span><span class="fu">terminate</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Keep running totals of heads, tails, and total flips.</span></span>
<span>  <span class="va">flips</span> <span class="op">&lt;-</span> <span class="fu">reactiveValues</span><span class="op">(</span>heads <span class="op">=</span> <span class="fl">0</span>, tails <span class="op">=</span> <span class="fl">0</span>, total <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Flip a batch of coins when the button is pressed.</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">button</span>, <span class="op">{</span></span>
<span>    <span class="va">controller</span><span class="op">$</span><span class="fu">walk</span><span class="op">(</span></span>
<span>      command <span class="op">=</span> <span class="fu">flip_coin</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      iterate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>flip_coin <span class="op">=</span> <span class="va">flip_coin</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Collect coin flip results.</span></span>
<span>  <span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">invalidateLater</span><span class="op">(</span>millis <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">collect</span><span class="op">(</span>error <span class="op">=</span> <span class="st">"stop"</span><span class="op">)</span></span>
<span>    <span class="fu">req</span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>    <span class="va">new_flips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span>    <span class="va">flips</span><span class="op">$</span><span class="va">heads</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">heads</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span></span>
<span>    <span class="va">flips</span><span class="op">$</span><span class="va">tails</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">tails</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">new_flips</span><span class="op">)</span></span>
<span>    <span class="va">flips</span><span class="op">$</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">total</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Print time and flip counts.</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">invalidateLater</span><span class="op">(</span>millis <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span>    <span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"%s | %s heads, %s tails, %s total"</span></span>
<span>    <span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%H:%M:%S"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="va">pattern</span>, <span class="va">time</span>, <span class="va">flips</span><span class="op">$</span><span class="va">heads</span>, <span class="va">flips</span><span class="op">$</span><span class="va">tails</span>, <span class="va">flips</span><span class="op">$</span><span class="va">total</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">shinyApp</span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-coin-flips-with-promises">Example: coin flips, with promises<a class="anchor" aria-label="anchor" href="#example-coin-flips-with-promises"></a>
</h2>
<p>The previous app feels choppy because it only refreshes every half
second. Using the powerful integration between <a href="https://rstudio.github.io/promises/" class="external-link"><code>promises</code></a> and
<a href="https://github.com/shikokuchuo/mirai" class="external-link"><code>mirai</code></a>,
we can make the UI respond as soon as a task finishes. Watch the video
below to see the difference:</p>
<p><a href="https://vimeo.com/954134172" class="external-link"><img src="figures/coins.png"></a></p>
<div class="section level3">
<h3 id="tutorial-1">Tutorial<a class="anchor" aria-label="anchor" href="#tutorial-1"></a>
</h3>
<p>The revised app has two changes. First, it takes <code>mirai</code>
task returned by <code>controller$push()</code> and turns it into a
special <a href="https://rstudio.github.io/promises/" class="external-link"><code>promise</code></a>.
This <a href="https://rstudio.github.io/promises/" class="external-link"><code>promise</code></a>
updates the coin flip counts as soon as the flip finishes.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">observeEvent</span><span class="op">(</span></span>
<span>  <span class="va">input</span><span class="op">$</span><span class="va">button</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span></span>
<span>    <span class="fl">1000</span>,</span>
<span>    <span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span><span class="fu">flip_coin</span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>flip_coin <span class="op">=</span> <span class="va">flip_coin</span><span class="op">)</span><span class="op">)</span> <span class="op">%...&gt;%</span></span>
<span>      <span class="fu">collect_flips</span><span class="op">(</span><span class="va">controller</span>, <span class="va">flips</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code>collect_flips()</code> function collects all the finished
flips and updates the flip counts.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">collect_flips</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ignore</span>, <span class="va">controller</span>, <span class="va">flips</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">new_flips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">controller</span><span class="op">$</span><span class="fu">collect</span><span class="op">(</span>error <span class="op">=</span> <span class="st">"stop"</span><span class="op">)</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">flips</span><span class="op">$</span><span class="va">heads</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">heads</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span></span>
<span>  <span class="va">flips</span><span class="op">$</span><span class="va">tails</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">tails</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">new_flips</span><span class="op">)</span></span>
<span>  <span class="va">flips</span><span class="op">$</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">total</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="full-app-code-1">Full app code<a class="anchor" aria-label="anchor" href="#full-app-code-1"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/promises/" class="external-link">promises</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">flip_coin</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.55</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">collect_flips</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ignore</span>, <span class="va">controller</span>, <span class="va">flips</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">new_flips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">controller</span><span class="op">$</span><span class="fu">collect</span><span class="op">(</span>error <span class="op">=</span> <span class="st">"stop"</span><span class="op">)</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">flips</span><span class="op">$</span><span class="va">heads</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">heads</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span></span>
<span>  <span class="va">flips</span><span class="op">$</span><span class="va">tails</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">tails</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">new_flips</span><span class="op">)</span></span>
<span>  <span class="va">flips</span><span class="op">$</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="va">flips</span><span class="op">$</span><span class="va">total</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">new_flips</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>  <span class="fu">div</span><span class="op">(</span><span class="st">"Is the coin fair?"</span><span class="op">)</span>,</span>
<span>  <span class="fu">actionButton</span><span class="op">(</span><span class="st">"button"</span>, <span class="st">"Flip 1000 coins"</span><span class="op">)</span>,</span>
<span>  <span class="fu">textOutput</span><span class="op">(</span><span class="st">"results"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># crew controller</span></span>
<span>  <span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu">crew</span><span class="fu">::</span><span class="fu"><a href="../reference/crew_controller_local.html">crew_controller_local</a></span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">10</span>, seconds_idle <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="va">controller</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">onStop</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">controller</span><span class="op">$</span><span class="fu">terminate</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Keep running totals of heads, tails, and total flips.</span></span>
<span>  <span class="va">flips</span> <span class="op">&lt;-</span> <span class="fu">reactiveValues</span><span class="op">(</span>heads <span class="op">=</span> <span class="fl">0</span>, tails <span class="op">=</span> <span class="fl">0</span>, total <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Flip a batch of coins when the button is pressed.</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span></span>
<span>    <span class="va">input</span><span class="op">$</span><span class="va">button</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span></span>
<span>      <span class="fl">1000</span>,</span>
<span>      <span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span><span class="fu">flip_coin</span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>flip_coin <span class="op">=</span> <span class="va">flip_coin</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>        <span class="fu">collect_flips</span><span class="op">(</span><span class="va">controller</span>, <span class="va">flips</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Print time and flip counts.</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">invalidateLater</span><span class="op">(</span>millis <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span>    <span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"%s | %s heads, %s tails, %s total"</span></span>
<span>    <span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%H:%M:%S"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="va">pattern</span>, <span class="va">time</span>, <span class="va">flips</span><span class="op">$</span><span class="va">heads</span>, <span class="va">flips</span><span class="op">$</span><span class="va">tails</span>, <span class="va">flips</span><span class="op">$</span><span class="va">total</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">shinyApp</span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by William Michael Landau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
